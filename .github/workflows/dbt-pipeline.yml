name: dbt ELT Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'modern-elt-warehouse/dbt_project/**'
      - 'modern-elt-warehouse/scripts/**'
      - 'modern-elt-warehouse/.github/workflows/dbt-pipeline.yml'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  DBT_VERSION: 1.11.2
  PYTHON_VERSION: '3.11'

jobs:
  dbt-validate:
    name: Validate dbt Project
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==${{ env.DBT_VERSION }} dbt-bigquery==${{ env.DBT_VERSION }}

      - name: Set up GCP credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          mkdir -p ~/.config/gcloud
          echo "$GCP_SA_KEY" > ~/.config/gcloud/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=~/.config/gcloud/service-account-key.json" >> $GITHUB_ENV

      - name: dbt Parse
        working-directory: modern-elt-warehouse/dbt_project
        run: dbt parse

      - name: dbt Debug
        working-directory: modern-elt-warehouse/dbt_project
        run: dbt debug

  dbt-test:
    name: Test dbt Models
    runs-on: ubuntu-latest
    needs: dbt-validate
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==${{ env.DBT_VERSION }} dbt-bigquery==${{ env.DBT_VERSION }}

      - name: Set up GCP credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          mkdir -p ~/.config/gcloud
          echo "$GCP_SA_KEY" > ~/.config/gcloud/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=~/.config/gcloud/service-account-key.json" >> $GITHUB_ENV

      - name: dbt Test (Staging Models)
        working-directory: modern-elt-warehouse/dbt_project
        run: dbt test --select staging --fail-fast

      - name: dbt Test (All Models)
        working-directory: modern-elt-warehouse/dbt_project
        continue-on-error: true
        run: dbt test

  dbt-run:
    name: Run dbt Models
    runs-on: ubuntu-latest
    needs: [dbt-validate, dbt-test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'schedule')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==${{ env.DBT_VERSION }} dbt-bigquery==${{ env.DBT_VERSION }}

      - name: Set up GCP credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          mkdir -p ~/.config/gcloud
          echo "$GCP_SA_KEY" > ~/.config/gcloud/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=~/.config/gcloud/service-account-key.json" >> $GITHUB_ENV

      - name: dbt Run (Dev)
        if: github.ref != 'refs/heads/main'
        working-directory: modern-elt-warehouse/dbt_project
        run: dbt run --target dev

      - name: dbt Run (Prod)
        if: github.ref == 'refs/heads/main'
        working-directory: modern-elt-warehouse/dbt_project
        run: dbt run --target prod

      - name: Generate dbt Docs
        if: github.ref == 'refs/heads/main'
        working-directory: modern-elt-warehouse/dbt_project
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
        run: dbt docs generate

      - name: Upload dbt Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts
          path: modern-elt-warehouse/dbt_project/target/
          retention-days: 30

  notify-status:
    name: Notify Pipeline Status
    runs-on: ubuntu-latest
    needs: [dbt-validate, dbt-test, dbt-run]
    if: always()
    
    steps:
      - name: Pipeline Status
        run: |
          echo "✅ dbt ELT Pipeline Completed"
          echo "Validation: ${{ needs.dbt-validate.result }}"
          echo "Testing: ${{ needs.dbt-test.result }}"
          echo "Running: ${{ needs.dbt-run.result }}"

      - name: Email Notification on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ dbt ELT Pipeline Failed - ${{ github.repository }}"
          to: sfaysal111@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            dbt ELT Pipeline has failed!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Pipeline Status:
            - Validation: ${{ needs.dbt-validate.result }}
            - Testing: ${{ needs.dbt-test.result }}
            - Running: ${{ needs.dbt-run.result }}
            
            View Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please check the logs and fix the issues.
