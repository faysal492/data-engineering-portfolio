name: dbt Run & Test

on:
  push:
    branches: [main]
    paths:
      - 'dbt_project/**'
      - '.github/workflows/dbt-run.yml'
  pull_request:
    branches: [main]
    paths:
      - 'dbt_project/**'

env:
  CLOUDSDK_PYTHON: /usr/bin/python3
  GCP_PROJECT_ID: modern-elt-warehouse
  DBT_PROFILES_DIR: ~/.dbt

jobs:
  dbt-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: dbt_project
        run: |
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure dbt profiles
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          brazilian_ecommerce:
            target: dev
            outputs:
              dev:
                type: bigquery
                project: ${{ env.GCP_PROJECT_ID }}
                dataset: olist_dev
                location: US
                priority: interactive
                timeout_seconds: 300
                retries: 1
                threads: 4
                method: oauth
              prod:
                type: bigquery
                project: ${{ env.GCP_PROJECT_ID }}
                dataset: olist_gold
                location: US
                priority: interactive
                timeout_seconds: 300
                retries: 1
                threads: 4
                method: oauth
          EOF

      - name: dbt parse & validate
        working-directory: dbt_project
        run: |
          dbt parse
          dbt debug

      - name: dbt run (staging models)
        working-directory: dbt_project
        run: dbt run --select staging

      - name: dbt run (intermediate models)
        working-directory: dbt_project
        run: dbt run --select intermediate

      - name: dbt run (mart models)
        working-directory: dbt_project
        run: dbt run --select marts

      - name: dbt test
        working-directory: dbt_project
        run: dbt test --select staging,intermediate,marts

      - name: dbt docs generate
        working-directory: dbt_project
        run: dbt docs generate

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dbt-test-results
          path: dbt_project/target/
          retention-days: 30

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ dbt pipeline failed. Check artifacts for details.'
            })

      - name: Notify on success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ dbt pipeline passed all tests successfully!'
            })
